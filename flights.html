<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Flight Deal Searcher</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Up to the minute flight alerts, dynamically scraped from the web">
    <meta name="author" content="Aran Khanna">

    <!-- styles -->
    <link href="bootstrap.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
  	
  	<!-- Google Fonts call. Font Used Open Sans & Open Sans Condensed -->
	<link href='http://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>    
	<style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
    </style>
    <link href="bootstrap-responsive.css" rel="stylesheet">

     <style>
	    body { font-size: 62.5%; }
	    label, input { display:block; }
	    input.text { margin-bottom:12px; width:95%; padding: .4em; }
	    fieldset { padding:0; border:0; margin-top:25px; }
	    h1 { font-size: 1.2em; margin: .6em 0; }
	    div#users-contain { width: 350px; margin: 20px 0; }
	    div#users-contain table { margin: 1em 0; border-collapse: collapse; width: 100%; }
	    div#users-contain table td, div#users-contain table th { border: 1px solid #eee; padding: .6em 10px; text-align: left; }
	    .ui-dialog .ui-state-error { padding: .3em; }
	    .validateTips { border: 1px solid transparent; padding: 0.3em; }
   	  </style>


    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

	<!-- Le favicon -->
    <link rel="shortcut icon" href="favicon.ico">

    <!-- JQuery -->
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
  	<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
  	<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <script type="text/javascript">
	    $.ajax({
		    type: "GET",
		    url: 'http://arankhanna.com/queryjson.php',
		    dataType: 'json',
		    success: function (data) {
		    	var info = $.map(data, function (item, i) {

		    					var departing_time = item.departing;
		    					var returning_time = item.returning;

		    					if(item.departing_flexible != 0){
		    						departing_time+=(item.departing_flexible+' days');
		    					}

		    					if(item.returning_flexible != 0){
		    						returning_time+=(item.returning_flexible+' days');
		    					}

		    					var leaving = item.leaving_from;
		    					var arriving = item.arriving_at;

		    					if(item.leaving_nearby == 1){
		    						leaving += ' or nearby';
		    					}

		    					if(item.arriving_nearby == 1){
		    						arriving += ' or nearby';
		    					}


					  			return "<tr id='row-" + item.id + "'><td>" + leaving + "</td><td>" + arriving + "</td><td>" + departing_time + "</td><td>" + returning_time + "</td><td>" + item.price_floor +"</td><td>" + item.current_price +"</td><td>" + item.last_updated +"</td><td><button class='create-user' id='" + item.id + "'>Add to email watchlist</button></td></tr>";
						}).join("");
		    	$('#all_queries').append(info);
		
			  	$(function() {
				    var 
				      email = $( "#email" ),
				      password = $( "#password" ),
				      allFields = $( [] ).add( name ).add( email ).add( password ),
				      tips = $( ".validateTips" );
				 
				    function updateTips( t ) {
				      tips
				        .text( t )
				        .addClass( "ui-state-highlight" );
				      setTimeout(function() {
				        tips.removeClass( "ui-state-highlight", 1500 );
				      }, 500 );
				    }
				 
				    function checkLength( o, n, min, max ) {
				      if ( o.val().length > max || o.val().length < min ) {
				        o.addClass( "ui-state-error" );
				        updateTips( "Length of " + n + " must be between " +
				          min + " and " + max + "." );
				        return false;
				      } else {
				        return true;
				      }
				    }
				 
				    function checkRegexp( o, regexp, n ) {
				      if ( !( regexp.test( o.val() ) ) ) {
				        o.addClass( "ui-state-error" );
				        updateTips( n );
				        return false;
				      } else {
				        return true;
				      }
				    }
				 
				    $( "#dialog-form" ).dialog({
				      autoOpen: false,
				      height: 300,
				      width: 350,
				      modal: true,
				      buttons: {
				        "Add email to alert list": function() {
				          var bValid = true;
				          allFields.removeClass( "ui-state-error" );
				 
				          bValid = bValid && checkLength( email, "email", 6, 80 );
				 
				          // From jquery.validate.js (by joern), contributed by Scott Gonzalez: http://projects.scottsplayground.com/email_address_validation/
				          bValid = bValid && checkRegexp( email, /^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i, "eg. ui@jquery.com" );
				 
				          if ( bValid ) {
				          		var final_id = $( "#flight-id" ).val();
				          		var final_email = $( "#email" ).val();
				              	var data = {"id":final_id,
							                "email": final_email}
							   	$.ajax({
							        type: "POST",
							        url: 'http://arankhanna.com/addwatcher.php',
							        data: data
							  	});
				              	$( this ).dialog( "close" );
				          }
				        },
				        "Delete Alert": function(){
				        	var final_id = $( "#flight-id" ).val();
				        	var data = {"id":final_id};
				        	$.ajax({
							        type: "POST",
							        url: 'http://arankhanna.com/deleteflight.php',
							        data: data
							  	}); 
				        	$( this ).dialog( "close" );
				        	$ ( "#row-"+final_id ).remove();
				        },
				        Cancel: function() {
				          $( this ).dialog( "close" );
				        }
				      },
				      close: function() {
				        allFields.val( "" ).removeClass( "ui-state-error" );
				      }
				    });
				 
				    $( ".create-user" )
				      .button()
				      .click(function() {
				        $( "#dialog-form" ).dialog( "open" );
				        var flight_id = $( this ).attr('id');
				        $( "#flight-id" ).val(flight_id);
				    });
				});
    		}
		});
	  </script>
	</head>
	<body>

		<!--TODO Construct Date Ranges:

		Routes and Price Floors:

		Email and Password: -->


		<style type="text/css">
			.tftable {font-size:12px;color:#333333;width:100%;border-width: 1px;border-color: #729ea5;border-collapse: collapse;}
			.tftable th {font-size:12px;background-color:#acc8cc;border-width: 1px;padding: 8px;border-style: solid;border-color: #729ea5;text-align:left;}
			.tftable tr {background-color:#d4e3e5;}
			.tftable td {font-size:12px;border-width: 1px;padding: 8px;border-style: solid;border-color: #729ea5;}
			.tftable tr:hover {background-color:#ffffff;}
		</style>
		<table class="tftable" border="1" id="all_queries">
			<tr><th>From</th><th>To</th><th>Leaving</th><th>Returning</th><th>Price Floor</th><th>Email</th><th>Password</th><th>Submit</th></tr>
			<form method="post" action="http://arankhanna.com/addflight.php" id="add_flight">
				<tr>
					<td>
						Airport Code:<input type="text" name="leaving_from" required="true">
						Nearby Airports:<input type="checkbox" checked="true" name="leaving_nearby">
					</td>
					<td>
						Airport Code:<input type="text" name="arriving_at" required="true">
						Nearby Airports:<input type="checkbox" checked="true" name="arriving_nearby">
					</td>
					<td>
						Departure Date:
						<input type="date" name="departing" required="true">
						Flexibility:
						<select name="departing_flexible" form="add_flight">
							<option value="0">Not Flexible</option>
							<option value="+-3">3 days before and after</option>
							<option value="+-2">2 days before and after</option>
							<option value="+-1">1 day before and after</option>
							<option value="+1">1 day after</option>
							<option value="-1">1 day before</option>
						</select>
					</td>
					<td>
						Returning Date:
						<input type="date" name="returning" required="true">
						Flexibility:
						<select name="returning_flexible" form="add_flight">
							<option value="0">Not Flexible</option>
							<option value="+-3">3 days before and after</option>
							<option value="+-2">2 days before and after</option>
							<option value="+-1">1 day before and after</option>
							<option value="+1">1 day after</option>
							<option value="-1">1 day before</option>
						</select>
					</td>
					<td>
						Price To Alert:<input type="number" name="price_floor" min="1" max="50000" required="true">
					</td>
					<td>
						Email To Alert:<input type="email" name="email" required="true">
					</td>
					<td>
						Do I Know You?:<input type="password" name="password" required="true">
					</td>
					<td>
						<input type="submit" value="Create Alert">
					</td>
				</tr>
			</form>
			<tr><th>From</th><th>To</th><th>Leaving</th><th>Returning</th><th>Price Floor</th><th>Current Price</th><th>Last Updated</th><th>Follow</th></tr>

		</table>

		<div id="dialog-form" title="Add to alert list">
  			<p class="validateTips">Add yourself to this list to get alerted when this flight price drops below the floor.</p>
		 	<form>
			  	<fieldset>
			    	<label for="email">Email</label>
			    	<input type="text" name="email" id="email" value="" class="text ui-widget-content ui-corner-all">
			    	<input type="hidden" name="id" id="flight-id" value="0">
			  	</fieldset>
		  	</form>
		</div>

	</body>
</html>